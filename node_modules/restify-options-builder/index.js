'use strict';

var _ = require( 'lodash' );

module.exports = function( server, options, routingBuilder ) {

    var opts = options || {};

    var optionsHandler = opts.optionsHandler
        || function( req, res, next ) {

            if( opts.responseHeaders ) {
                _.forIn( opts.responseHeaders, function( value, key ) {
                    res.header( key, value );
                } );
            }

            if( res.methods && res.methods.length > 0 ) {

                var methods = res.methods.join( ', ' );
                res.header( 'allow', methods );

                if( opts.setAcessControlAllowMethods || opts.setAccessControlAllowMethods ) {
                    res.header( 'access-control-allow-methods', methods );
                }
            }

            res.send( 204 );
            next();
        };

    var routing = {};

    [ 'get', 'head', 'post', 'put', 'patch', 'del' ].forEach( function( method ) {
        routing[ method ] = function( route ) {

            server.opts( route, optionsHandler );
            server[ method ].apply( server, arguments );
        };
    } );

    routingBuilder( routing );

};
